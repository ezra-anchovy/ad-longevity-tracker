import PDFDocument from 'pdfkit';
import fs from 'fs';
import { getVeteranAds, getNewAds, getAllAds } from './db.js';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

function generateWeeklyReport() {
  console.log('ðŸ“„ Generating Winners Report...\n');
  
  const veteranAds = getVeteranAds(30, 10);
  const newAds = getNewAds(7);
  const allAds = getAllAds();
  
  // Calculate statistics
  const totalAds = allAds.length;
  const avgDaysRunning = allAds.reduce((sum, ad) => sum + ad.days_running, 0) / totalAds || 0;
  
  const categoryBreakdown = {};
  const hookBreakdown = {};
  
  allAds.forEach(ad => {
    categoryBreakdown[ad.ai_category || 'unknown'] = (categoryBreakdown[ad.ai_category || 'unknown'] || 0) + 1;
    hookBreakdown[ad.ai_hook || 'unknown'] = (hookBreakdown[ad.ai_hook || 'unknown'] || 0) + 1;
  });
  
  // Create PDF
  const doc = new PDFDocument({ margin: 50 });
  const outputPath = join(__dirname, '../data/winners-report.pdf');
  doc.pipe(fs.createWriteStream(outputPath));
  
  // Header
  doc.fontSize(24).font('Helvetica-Bold').text('Ad Longevity Winners Report', { align: 'center' });
  doc.fontSize(12).font('Helvetica').text(`Generated: ${new Date().toLocaleDateString()}`, { align: 'center' });
  doc.moveDown(2);
  
  // Summary Stats
  doc.fontSize(16).font('Helvetica-Bold').text('ðŸ“Š Summary Statistics');
  doc.moveDown(0.5);
  doc.fontSize(11).font('Helvetica');
  doc.text(`Total Active Ads: ${totalAds}`);
  doc.text(`Average Days Running: ${avgDaysRunning.toFixed(1)}`);
  doc.text(`Veteran Ads (>30 days): ${veteranAds.length}`);
  doc.text(`New Launches (Last 7 days): ${newAds.length}`);
  doc.moveDown(2);
  
  // Top 10 Longest-Running Ads
  doc.fontSize(16).font('Helvetica-Bold').text('ðŸ† Top 10 Longest-Running Ads (Winners)');
  doc.moveDown(0.5);
  
  veteranAds.forEach((ad, idx) => {
    doc.fontSize(11).font('Helvetica-Bold').text(`${idx + 1}. ${ad.page_name} - ${ad.days_running} days`);
    doc.fontSize(10).font('Helvetica');
    doc.text(`   Headline: ${ad.headline?.substring(0, 100) || 'N/A'}...`);
    doc.text(`   Type: ${ad.ai_category || ad.ad_type} | Hook: ${ad.ai_hook || 'N/A'}`);
    doc.moveDown(0.5);
  });
  
  doc.addPage();
  
  // New Launches
  doc.fontSize(16).font('Helvetica-Bold').text('ðŸš€ New Launches (Last 7 Days)');
  doc.moveDown(0.5);
  
  if (newAds.length === 0) {
    doc.fontSize(11).font('Helvetica').text('No new ads launched in the past 7 days.');
  } else {
    newAds.slice(0, 10).forEach((ad, idx) => {
      doc.fontSize(11).font('Helvetica-Bold').text(`${idx + 1}. ${ad.page_name} - ${ad.days_running} days old`);
      doc.fontSize(10).font('Helvetica');
      doc.text(`   Headline: ${ad.headline?.substring(0, 100) || 'N/A'}...`);
      doc.text(`   Type: ${ad.ai_category || ad.ad_type} | Hook: ${ad.ai_hook || 'N/A'}`);
      doc.moveDown(0.5);
    });
  }
  
  doc.moveDown(2);
  
  // Creative Breakdown
  doc.fontSize(16).font('Helvetica-Bold').text('ðŸŽ¨ Creative Breakdown');
  doc.moveDown(0.5);
  
  doc.fontSize(12).font('Helvetica-Bold').text('By Category:');
  Object.entries(categoryBreakdown)
    .sort((a, b) => b[1] - a[1])
    .forEach(([category, count]) => {
      const percentage = ((count / totalAds) * 100).toFixed(1);
      doc.fontSize(10).font('Helvetica').text(`  ${category}: ${count} (${percentage}%)`);
    });
  
  doc.moveDown(1);
  doc.fontSize(12).font('Helvetica-Bold').text('By Hook/Angle:');
  Object.entries(hookBreakdown)
    .sort((a, b) => b[1] - a[1])
    .forEach(([hook, count]) => {
      const percentage = ((count / totalAds) * 100).toFixed(1);
      doc.fontSize(10).font('Helvetica').text(`  ${hook}: ${count} (${percentage}%)`);
    });
  
  doc.addPage();
  
  // Suggested Creative Angles
  doc.fontSize(16).font('Helvetica-Bold').text('ðŸ’¡ Suggested Creative Angles');
  doc.moveDown(0.5);
  doc.fontSize(11).font('Helvetica');
  
  const topHook = Object.entries(hookBreakdown).sort((a, b) => b[1] - a[1])[0];
  const topCategory = Object.entries(categoryBreakdown).sort((a, b) => b[1] - a[1])[0];
  
  doc.text(`1. Double down on "${topHook?.[0] || 'emotional'}" hooks - they dominate veteran ads`);
  doc.text(`2. Test "${topCategory?.[0] || 'video'}" format - highest winning percentage`);
  doc.text(`3. Look for patterns in 30+ day ads - these are proven profitable`);
  doc.text(`4. Watch for new launches from top performers - early trend indicators`);
  doc.text(`5. Test similar headline structures to top veterans`);
  
  doc.moveDown(2);
  doc.fontSize(9).fillColor('gray').text('Generated by Ad Longevity Tracker | anchovylabs.ai', { align: 'center' });
  
  doc.end();
  
  console.log(`âœ… Report saved to: ${outputPath}`);
  return outputPath;
}

if (import.meta.url === `file://${process.argv[1]}`) {
  generateWeeklyReport();
}

export { generateWeeklyReport };
